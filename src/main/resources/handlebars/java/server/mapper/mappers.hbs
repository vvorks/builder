//
// Mapperユーティリティクラス
//
{{#java this "server/mapper/Mappers" ".java"}}
{{#if global.project.copyrightLines}}
/*
{{#each global.project.copyrightLines}}
 * {{this}}
{{/each}}
 */
{{/if}}
package {{global.project.projectName}}.server.mapper;

import java.util.HashMap;
import java.util.Map;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.config.BeanPostProcessor;
import org.springframework.stereotype.Component;
import {{global.project.projectName}}.common.logging.Logger;
import {{global.project.projectName}}.server.domain.{{upperLastName}}Content;

@Component
public class Mappers implements BeanPostProcessor {

	private static final Logger LOGGER = Logger.createLogger(Mappers.class);

	private static Mappers instance;

	public static Mappers get() {
		LOGGER.info("Mappers instance ", instance != null);
		return instance;
	}

	{{#each classes}}

	/** {{titleOrName}}のMapper */
	@Autowired
	private {{className}}Mapper {{lowerName}}Mapper;
	{{/each}}

	private Map<String, MapperInterface<?>> mapperMap;

	public Mappers() {
		instance = this;
	}

	@Override
	public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
		if (beanName.equals("dataSourceScriptDatabaseInitializer")) {
			initCounter();
		}
		return bean;
	}

	private void initCounter() {
		{{upperLastName}}Content obj;
		{{#each surrogateClasses}}
		do {
			obj = {{../lastName}}Mapper.get("{{className}}");
			obj.setSurrogateCount({{lowerName}}Mapper.listSummary().getMax{{surrogateField.upperName}}());
			obj = {{../lastName}}Mapper.update(obj) ? obj : null;
		} while (obj == null);
		{{/each}}
	}

	{{#each classes}}

	/** {{titleOrName}}のMapperを取得する */
	public {{className}}Mapper get{{className}}Mapper() {
		return {{lowerName}}Mapper;
	}
	{{/each}}

	{{#each surrogateClasses}}

	/** {{titleOrName}}のIdを新規発番する */
	public synchronized int new{{className}}Id() {
		{{upperLastName}}Content obj;
		do {
			obj = {{../lastName}}Mapper.get("{{className}}");
			obj.setSurrogateCount(obj.getSurrogateCount() + 1);
			obj = {{../lastName}}Mapper.update(obj) ? obj : null;
		} while (obj == null);
		return obj.getSurrogateCount();
	}
	{{/each}}

	public MapperInterface<?> getMapperOf(String name) {
		if (mapperMap == null) {
			mapperMap = new HashMap<>();
			{{#each classes}}
			mapperMap.put("{{className}}", {{lowerName}}Mapper);
			{{/each}}
		}
		return mapperMap.get(name);
	}

}
{{/java}}
